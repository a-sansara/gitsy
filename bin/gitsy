#!/bin/bash

  GITSY_HOOKNAME=${1:-''}; shift
    GITSY_PARAMS="$@"
        GITSY_WK="$(pwd)"
    GITSY_ORIGIN="origin"
    GITSY_UPSYNC="upsync"
   GITSY_NOCOLOR=0
 GITSY_PULLFIRST=0
    GITSY_SCRIPT=$0
   GITSY_VERSION=0.2
GITSY_TERM_WIDTH=105

if [ "$GITSY_HOOKNAME" = "-h" ]; then
    GITSY_HOOKNAME="help"
fi
if [ "$GITSY_HOOKNAME" = "-v" ]; then
    echo $GITSY_VERSION
    exit
fi

      GITSY_HOOK="gitsy.${GITSY_HOOKNAME//-/.}"

if [ "$GITSY_NOCOLOR" -eq 0 ]; then
             Cok="\033[0;38;5;36m"
             Cko="\033[0;38;5;176m"
            Coff="\033[m"
          Ctitle="\033[1;48;5;23;1;38;5;15m"
           Ctsep="\033[1;48;5;23;1;38;5;227m"
            Cspe="\033[1;38;5;223m"
           Citem="\033[1;38;5;209m"
            Cval="\033[1;38;5;215m"
            Cusa="\033[1;38;5;214m"
            Cbra="\033[1;38;5;203m"
           Ctext="\033[1;38;5;30m"
            Copt="\033[1;38;5;84m"
            Csep="\033[1;38;5;241m"
            Cerr="\033[1;38;5;196m"
fi

# -------------------------------------------------------
function gitsy.echo(){
    local      msg=${1:-''}
    local isAction=${2:-'0'}
    local   symbol=${3:-'  *'}
    if [ ! "$GITSY_NOCOLOR" = 1 ]; then
        local   c=$Cko
        if [ -z "$isAction" ] || [ "$isAction" = 1 ]; then
            c=$Cok
        fi
        if [ ! "$isAction" = 0 ]; then
            c=" $Citem$symbol $c"
        fi
        echo -e " $c$msg$Coff"
    else
        if [ ! "$isAction" = 0 ]; then
            msg=" $symbol $msg"
        fi
        echo -e "$msg"
    fi
}
# -------------------------------------------------------
function gitsy.echo.action(){
    gitsy.echo "$1" 1
}
# -------------------------------------------------------
function gitsy.echo.keyval(){
    local c=': '
    if [ ! "$GITSY_NOCOLOR" = 1 ]; then
        c="$Citem: ${Cval}"
    fi
    gitsy.echo "  $1 $c$2" 1 " "
}
# -------------------------------------------------------
function gitsy.echo.state(){
    if [ "$1" = 0 ]; then
        echo "      done !"
    else 
        echo "      fail !"
    fi
}
# -------------------------------------------------------
function gitsy.echo.error(){
    echo -e "${Cerr}    error : ${Coff} $1 ${Coff}\n"
}
# -------------------------------------------------------
function gitsy.sepline(){
    local  char=${1:-'_'}
    local width=${2:-$GITSY_TERM_WIDTH}
    echo -ne "${Csep} "
    printf "%0.s$char" $(seq 1 $width)
    echo -e "\n"
}
# -------------------------------------------------------
function gitsy.title(){
    local msg=${1:-''}
    local len="  :: $msg :: author : a-Sansara"
    gitsy.sepline
    echo -ne " $Ctsep :: $Ctitle$msg $Ctsep:: $Coff"
    printf "%0.s " $(seq 1 $(($GITSY_TERM_WIDTH-${#len}-2)))
    echo -e " ${Cok}author : ${Cval}a-Sansara"
    gitsy.sepline
}
# -------------------------------------------------------
function gitsy.branch.trackAll(){
    local origin=${1:-$GITSY_ORIGIN}
    gitsy.title "Tracking $Cspe$origin"
    for name in $(gitsy.remote.branch $origin); do 
        git checkout -t $origin/$name > /dev/null 2>&1
        local ec=$?
        if [ $ec -eq 128 ]; then
            gitsy.echo.item "existing branch $name. pass" 0
        elif [ $ec -eq 0 ]; then
            gitsy.echo.item "tracking branch $name. done"
        fi
    done
}
# -------------------------------------------------------
function gitsy.remote.branch(){
    local origin=${1:-$GITSY_ORIGIN}
    git branch -r --color=never | grep "$origin/" | grep -v HEAD | sed -e 's/.*\///g'
}
# -------------------------------------------------------
function gitsy.upstream.track(){
      local origin=${1:-$GITSY_ORIGIN}
    local upstream=${2:-$GITSY_UPSTREAM}
    for name in $(gitsy.remote.branch $origin); do 
        git branch -t $name  $upstream/$name ;
    done
}
# -------------------------------------------------------
function gitsy.mktemp(){
    tfile="$(mktemp)"
    if [ ! -f "$tfile" ]; then
        gitsy.echo.error "can't make temp file"
        exit 1
    fi
}
# -------------------------------------------------------
function gitsy.match.infile(){
    local match=1
    local repo=''
    if [ -f "$2" ]; then
        while read repo; do
            if [ "$repo" = "$1" ]; then
                match=0
                break
            fi
        done < "$2"
    fi
    return $match
}
# -------------------------------------------------------
function gitsy.match.remote(){
    local match=1
    local repo=''
    for repo in $(git remote -v | grep ^${GITSY_UPSYNC}[^\(]*\(push\)$ | cut -f 1); do
        if [ "$repo" = "$1" ]; then
            match=0
            break
        fi
    done
    return $match
}
# -------------------------------------------------------
function gitsy.remove.infile(){
    gitsy.mktemp
    grep -v "$1" "$2" > "$tfile" && mv "$tfile" "$2"
}
# -------------------------------------------------------
function gisty.sync.list(){
    local repo=''
    if [ -f ".gitsy" ]; then
        while read repo; do
            if [ ! -z "$repo" ]; then
                echo -e "         - ${Cval}$repo${Coff}"
            fi
        done < .gitsy
    fi
}
# -------------------------------------------------------
function gitsy.parse.push.args(){
    for ((i=1;i<=${#};i++)); do
        if [ ! "${!i:0:1}" = "-" ]; then
            if [ -z "$repo" ]; then
                repo=${!i}
            else
                branch=${!i}
            fi
        else
            opt=${!i}
        fi
    done
}
# -------------------------------------------------------
function gitsy.spush(){
    local opt repo branch i rs
    gitsy.parse.push.args $@
    gitsy.echo.action "pushing on ${Copt}$opt ${Cspe}$repo ${Cbra}$branch\n"
    result=$(git push $opt $repo $branch 2>&1)
    rs=$?
    echo -e "$result" | sed "s/^/      /"
    if [ "$rs" = 0 ]; then
        gitsy.echo.state 0
        echo
        gitsy.echo.action "looking for upsync repositories"
        gisty.sync.list
        echo
        for name in $(git remote -v | grep ^${GITSY_UPSYNC}[^\(]*\(push\)$ | cut -f 1); do
            gitsy.echo.action "pushing on ${Copt}$opt ${Cspe}$name ${Cbra}$branch"
            if [ "$GITSY_PULLFIRST" = 1 ]; then
                echo
                result=$(git pull $name $branch 2>&1)
                rs=$?
                echo -e "$result" | sed "s/^/      /"
                gitsy.echo.state "$rs"
            fi
            echo
            result=$(git push $opt $name $branch 2>&1)
            rs=$?
            echo -e "$result" | sed "s/^/      /"
            gitsy.echo.state "$rs"
            echo 
        done
    else 
        gitsy.echo.state 1
    fi
}
# -------------------------------------------------------
function gitsy.disync(){
    local repo=${1:-''}
    if [ ! -z "$repo" ]; then
        if [ ! "${repo:0:${#GITSY_UPSYNC}}" = "$GITSY_UPSYNC" ]; then
            repo="$GITSY_UPSYNC-$repo"
        fi
        gitsy.remove.infile "$repo" ".gitsy"
        echo
        gitsy.echo.action "synchro list : "
        gisty.sync.list
    else
        gitsy.error "you must specified a repository !"
    fi
}

# -------------------------------------------------------
function gitsy.upsync(){
    if [ -d ./.git ]; then
        local repo=${1:-''}
        local  url=${2:-''}
        if [ ! -z "$repo" ]; then
            if [ ! "${repo:0:${#GITSY_UPSYNC}}" = "$GITSY_UPSYNC" ]; then
                repo="$GITSY_UPSYNC-$repo"
            fi

            if ! gitsy.match.infile "$repo" ".gitsy"; then
                gitsy.echo.action "upsync new remote repository : ${Cspe}$repo"
                echo -e "$repo" >> ".gitsy"
            else
                gitsy.echo.action "enabling upsync remote repository : ${Cspe}$repo"
            fi
            #~ gitsy.remove.infile "$repo" ".gitsy"
            if gitsy.match.remote "$repo"; then
                gitsy.echo "     git remote already exists"
            else
                if [ -z "$url" ]; then
                    gitsy.error "you must specified a remote url !"
                else
                    gitsy.echo.action "git adding remote ${Cspe}$repo ${Cbra}$url"
                    git remote add "$repo" "$url"
                fi
            fi
            echo
            gitsy.echo.action "synchro list : "
            gisty.sync.list
            echo -e "
      You can now use :
      ${Cspe}git spush ${Copt}repository ${Cbra}branch${Coff}
"
        else
            gitsy.error "you must specified a REPOSITORY !"
        fi
    fi
}
# -------------------------------------------------------
function gitsy.error(){
    local withUsage=${2:-1}
    gitsy.echo.error "$1"
    if [ "$withUsage" = 1 ]; then
        gitsy.usage
    fi
    exit 1
}
# -------------------------------------------------------
function gitsy.version(){
    echo " $GITSY_VERSION"
    exit
}
# -------------------------------------------------------
function gitsy.help(){
    gitsy.usage
}
# -------------------------------------------------------
function gitsy.install(){
    local dir=${1:-'/usr/bin'}
    local spush=''
    local uid
    local usr
    if [ -d "$dir" ]; then
        gitsy.echo.action "installing in ${Cspe}$dir ${Cok}directory"
        cp $GITSY_SCRIPT "$dir/gitsy" > /dev/null 2>&1
        if [ "$?" -eq 0 ]; then
            spush="$(git config --list | grep alias.spush)"
            if [ ! -z "$spush" ]; then
                if [ "$spush" = "alias.spush=!bash gitsy spush" ]; then
                    gitsy.echo "     git alias spush already exists. skip"
                else
                    gitsy.error "git alias.spush exists in ~/.gitconfig but has a wrong definition. remove it or rename it" 0
                fi
            else
                usr=$(logname)
                gitsy.echo.action "enabling git alias ${Cspe}spush ${Cok}for user ${Cbra}$usr"
                su -c "git config --global alias.spush '!bash gitsy spush'" $usr
            fi
            gitsy.echo.state 0
        else
            gitsy.echo.error "permission denied"
            gitsy.echo.state 1
            exit 1
        fi
    else
        gitsy.echo.error "directory ${Cspe}'$dir'${Coff} does not exists"
        exit 1
    fi
}
# -------------------------------------------------------
function gitsy.usage(){
    echo -e "    ${Cusa}usage :${Coff}

    ${Cspe}\tgitsy  ${Copt}post-push  ${Ctext}REPOSITORY BRANCH
    ${Cspe}\tgitsy  ${Copt}upsync     ${Ctext}REPOSITORY ${Copt}[ ${Ctext}URL${Copt} ]
    ${Cspe}\tgitsy  ${Copt}disync     ${Ctext}REPOSITORY
    ${Cspe}\tgitsy  ${Copt}install    ${Copt}[ ${Ctext}BINDIR${Copt} ]
    ${Cspe}\tgitsy  ${Copt}help
    ${Cspe}\tgitsy  ${Copt}version
${Coff}
"
}

# -------------------------------------------------------

gitsy.title "GITSY"

if [ ! -z "$GITSY_HOOKNAME" ]; then
    type $GITSY_HOOK > /dev/null 2>&1
    if [ $? -eq 0 ]; then
        #~ echo -e " ${Cspe}command ${Copt}$GITSY_HOOKNAME ${Ctext}$GITSY_PARAMS${Coff}\n"
        $GITSY_HOOK $GITSY_PARAMS
        echo
    else
        gitsy.error "invalid command ${Cspe}$GITSY_HOOKNAME${Coff}"
    fi
else
    gitsy.error "you must specified a command !"
fi
